<!DOCTYPE html>
<html>
  <head>
    <title>Hello world</title>
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
  </head>
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    html {
      font-size: 13px;
    }
    body {
      font: 13px Helvetica, Arial;
      margin-bottom: 50px;
    }

    input {
      padding: 10px;
      min-width: 100px;
    }
    .input-container {
      width: 100%;
      position: fixed;
      bottom: 0;
      left: 0;
      display: flex;
    }
    span.small-text {
      font-size: 0.8rem;
      color: rgb(133, 131, 131);
      padding-right: 20px;
    }
    #send-button {
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
      text-align: center;
    }
    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    #messages li {
      padding: 5px 10px;
    }
    #messages li.self_message {
      background: rgb(225, 241, 255);
    }
    .user_input {
      flex: 1;
    }
    .message_input {
      flex: 3;
    }
    .room_container {
      display: inline;
      position: fixed;
      right: 0;
      top: 0;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

  <body>
    <div class="input-container">
      <input class="user_input" placeholder="username" />
      <input class="message_input" placeholder="message" />
      <button id="send-button">Send</button>
    </div>
    <div class="room_container">
      <select>
        <option value="0">Main room</option>
        <option value="1">Room 1</option>
        <option value="2">Room 2</option>
        <option value="3">Room 3</option>
      </select>
    </div>
    <ul id="messages"></ul>
  </body>
  <script>
    const socket = io();
    const button = document.querySelector('#send-button');
    const messageInput = document.querySelector('.message_input');
    const userInput = document.querySelector('.user_input');
    const messages = document.querySelector('#messages');
    const roomInput = document.querySelector('.room_container>select');

    let userID;
    const storageName = 'sessionStorage';
    if (window[storageName].userID) {
      userID = window[storageName].userID;
    } else {
      userID = Date.now();
      window[storageName].userID = userID;
    }

    const socketEvents = {
      CONNECTION: 'connection',
      DISCONNECT: 'disconnect',
      INIT: 'init',
      MESSAGE: 'message',
      CLEAR: 'clear',
      JOIN_ROOM: 'join room'
    };

    button.addEventListener('click', sendMessage);
    roomInput.addEventListener('change', ev => {
      socket.emit(socketEvents.JOIN_ROOM, { userID, roomID: roomInput.value });
    });
    messageInput.addEventListener('keydown', ev => {
      if (ev.key === 'Enter') {
        sendMessage();
      }
    });

    function sendMessage() {
      if (messageInput.value) {
        socket.emit(socketEvents.MESSAGE, {
          message: messageInput.value,
          username: userInput.value,
          roomID: roomInput.value,
          userID: userID,
          time: getTime()
        });
        messageInput.value = '';
      }
    }

    function clearChat() {
      socket.emit(socketEvents.CLEAR);
    }

    function getTime() {
      return new Date().toLocaleTimeString(undefined, { hour12: false });
    }

    socket.emit(socketEvents.INIT);
    socket.on(socketEvents.INIT, messages => {
      messages.forEach(message => showMessageFromServer(message));
    });

    socket.on(socketEvents.JOIN_ROOM, data => {
      const { roomID } = data;
      const user = data.userID === userID ? "You've" : 'New user';
      const li = document.createElement('li');
      const span = document.createElement('span');
      span.classList.add('small-text');
      span.textContent = `${user} joined ${getRoomName(roomID)}`;
      li.appendChild(span);
      messages.appendChild(li);
      li.scrollIntoView(true);
    });

    function getRoomName(roomID) {
      return roomID === '0' ? 'Main room' : `Room ${roomID}`;
    }

    function showMessageFromServer(data) {
      const li = document.createElement('li');
      if (data.userID === userID) {
        li.classList.add('self_message');
      }
      const { username, message, time, roomID } = data;
      const span = document.createElement('span');
      span.classList.add('small-text');
      span.textContent = `${username}: ${time} ${getRoomName(roomID)}`;
      const text = document.createTextNode(message);
      li.appendChild(span);
      li.appendChild(text);
      messages.appendChild(li);
      li.scrollIntoView(true);
    }

    socket.on(socketEvents.MESSAGE, data => {
      showMessageFromServer(data);
    });

    socket.on(socketEvents.CLEAR, data => {
      messages.innerHTML = '';
    });
  </script>
</html>
