<!DOCTYPE html>
<html>
  <head>
    <title>Hello world</title>
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
  </head>
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    html {
      font-size: 13px;
    }
    body {
      font: 13px Helvetica, Arial;
      margin-bottom: 50px;
    }

    input {
      padding: 10px;
      min-width: 100px;
    }
    .input-container {
      width: 100%;
      position: fixed;
      bottom: 0;
      left: 0;
      display: flex;
    }
    span.username {
      font-size: 0.8rem;
      color: rgb(133, 131, 131);
      padding-right: 20px;
    }
    #send-button {
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
      text-align: center;
    }
    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    #messages li {
      padding: 5px 10px;
    }
    #messages li.self_message {
      background: rgb(225, 241, 255);
    }
    .user_input {
      flex: 1;
    }
    .message_input {
      flex: 3;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

  <body>
    <div class="input-container">
      <input class="user_input" placeholder="username" />
      <input class="message_input" placeholder="message" />
      <button id="send-button">Send</button>
    </div>
    <ul id="messages"></ul>
  </body>
  <script>
    const socket = io();
    const button = document.querySelector('#send-button');
    const messageInput = document.querySelector('.message_input');
    const userInput = document.querySelector('.user_input');
    const messages = document.querySelector('#messages');
    const userID = Date.now();
    const socketEvents = {
      CONNECTION: 'connection',
      DISCONNECT: 'disconnect',
      INIT: 'init',
      MESSAGE: 'message',
      CLEAR: 'clear'
    };

    button.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', ev => {
      if (ev.key === 'Enter') {
        sendMessage();
      }
    });

    function sendMessage() {
      if (messageInput.value) {
        socket.emit(socketEvents.MESSAGE, {
          message: messageInput.value,
          username: userInput.value,
          userID: userID,
          time: getTime()
        });
        messageInput.value = '';
      }
    }

    function clearChat() {
      socket.emit(socketEvents.CLEAR);
    }

    function getTime() {
      return new Date().toLocaleTimeString(undefined, { hour12: false });
    }

    socket.emit(socketEvents.INIT);
    socket.on(socketEvents.INIT, messages => {
      messages.forEach(message => showMessageFromServer(message));
    });

    function showMessageFromServer(data) {
      const li = document.createElement('li');
      if (data.userID === userID) {
        li.classList.add('self_message');
      }
      const { username, message, time } = data;
      li.innerHTML =
        `<span class="username">${username}: ${time}</span>` + `${message}`;
      messages.appendChild(li);
      li.scrollIntoView(true);
    }

    socket.on(socketEvents.MESSAGE, data => {
      showMessageFromServer(data);
    });

    socket.on(socketEvents.CLEAR, data => {
      messages.innerHTML = '';
    });
  </script>
</html>
